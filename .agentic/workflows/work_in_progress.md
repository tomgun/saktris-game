# Work-In-Progress (WIP) Tracking & Recovery

**Purpose**: Prevent loss of work when tokens run out, tools crash, or context gets compacted. Automatic detection and recovery of interrupted work.

**Core idea**: A lock file tracks "I'm working on X". If lock exists at session start but work not completed = interrupted work detected.

---

## The Problem

**Work can be lost when:**
- ‚ùå Token limit reached mid-feature (agent stops abruptly)
- ‚ùå Tool crashes or user closes it unexpectedly
- ‚ùå Context compaction happens (Claude)
- ‚ùå Switching environments mid-task (forgot to log)
- ‚ùå Computer crashes or freezes

**Current mitigation** (partial):
- `session_log.sh` for frequent checkpoints
- Claude `PreCompact` hook for auto-logging
- **But**: If agent crashes BEFORE checkpoint = work lost!

**What we need:**
1. Track "I'm currently working on X" (lock file)
2. Detect interrupted work at session start
3. Show what changed (git diff)
4. Offer recovery: Continue | Review | Rollback

---

## Solution: WIP.md Lock File

### Location

`WIP.md` in project root (visible, easy to find)

### Content Format

```yaml
# Work In Progress (DO NOT EDIT MANUALLY)

## Current Task

- **Feature**: F-0005: User Authentication
- **Agent**: claude-desktop
- **Started**: 2025-01-08 14:23:45
- **Last checkpoint**: 2025-01-08 14:35:12 (12 minutes ago)
- **Expected duration**: ~30 minutes

## Task Details

**What I'm doing**:
- Implementing JWT token validation
- Adding unit tests for auth flow
- Updating FEATURES.md after completion

**Files being edited**:
- src/auth/login.ts (modified)
- src/auth/types.ts (new)
- tests/auth/login.test.ts (new)

**Progress**:
- [x] Created types for User and Token
- [x] Implemented login endpoint
- [ ] Add JWT validation (IN PROGRESS)
- [ ] Write unit tests
- [ ] Update FEATURES.md

**If this file still exists when you return:**
- Check `git status` to see uncommitted changes
- Check `git diff` to review what was changed
- Check `SESSION_LOG.md` for last checkpoint details
- Decide: Continue | Review changes | Rollback (git reset)

---

**Auto-generated by**: `.agentic/tools/wip.sh`
**Remove when**: Task complete and changes committed
```

---

## Usage: wip.sh Script

### Create WIP lock

```bash
# Start work on a feature
bash .agentic/tools/wip.sh start F-0005 "Implementing user authentication" \
  "src/auth/login.ts,src/auth/types.ts,tests/auth/login.test.ts"
```

### Update WIP checkpoint

```bash
# Update progress (call frequently, every ~15 min)
bash .agentic/tools/wip.sh checkpoint "Implemented login endpoint, starting JWT validation"
```

### Complete and remove WIP

```bash
# Work complete, remove lock
bash .agentic/tools/wip.sh complete
```

### Check for interrupted work

```bash
# At session start (automatic in session_start.md)
bash .agentic/tools/wip.sh check
```

**Output if interrupted:**
```
‚ö†Ô∏è  INTERRUPTED WORK DETECTED

Feature: F-0005: User Authentication
Started: 2025-01-08 14:23:45 (45 minutes ago)
Last checkpoint: 2025-01-08 14:35:12 (33 minutes ago)
Agent: claude-desktop

Files changed (git status):
  M  src/auth/login.ts
  A  src/auth/types.ts
  A  tests/auth/login.test.ts

Last checkpoint details (SESSION_LOG.md):
  "Implemented login endpoint, starting JWT validation"

OPTIONS:
1. Continue work (recommended if progress was good)
2. Review changes (git diff) before deciding
3. Rollback to last commit (git reset --hard)

What would you like to do?
```

---

## Integration Points

### 1. Session Start Checklist

**UPDATED: `.agentic/checklists/session_start.md`**

Add as FIRST step:
```markdown
## üö® Check for Interrupted Work (CRITICAL)

- [ ] **Run WIP check**:
  ```bash
  bash .agentic/tools/wip.sh check
  ```

- [ ] **If interrupted work detected**:
  - Review what was changed (git diff)
  - Read last checkpoint in SESSION_LOG.md
  - Decide: Continue | Review | Rollback
  - Tell user about interrupted work

- [ ] **If no interrupted work**:
  - Proceed with normal session start
```

### 2. Feature Implementation Workflow

**When starting work on a feature:**
```bash
# 1. Create WIP lock
bash .agentic/tools/wip.sh start F-0005 "User authentication" "src/auth/*.ts,tests/auth/*.test.ts"

# 2. Work on feature...

# 3. Checkpoint frequently (every ~15 min or after significant step)
bash .agentic/tools/wip.sh checkpoint "Login endpoint done, starting JWT"

# 4. When complete
bash .agentic/tools/wip.sh complete
git add -A && git commit -m "feat: F-0005 user authentication"
```

### 3. Claude Hooks (Automatic)

**UPDATED: `.agentic/claude-hooks/PreCompact.sh`**

```bash
# Before context compaction, update WIP checkpoint
if [[ -f "WIP.md" ]]; then
  bash .agentic/tools/wip.sh checkpoint "Context compaction triggered"
fi
```

**UPDATED: `.agentic/claude-hooks/Stop.sh`**

```bash
# Warn user about uncommitted WIP
if [[ -f "WIP.md" ]]; then
  echo "‚ö†Ô∏è  WIP.md exists - work may be incomplete!"
  echo "   Check git status before closing."
fi
```

### 4. Environment Switching

**Before switching environments:**
```bash
# Update WIP with handoff note
bash .agentic/tools/wip.sh checkpoint "Switching from Claude to Cursor"

# In new environment, session start will detect WIP and continue
```

### 5. Multi-Agent Coordination

**WIP.md acts as a lock for multi-agent scenarios:**

```bash
# Check if another agent is working
bash .agentic/tools/wip.sh check

# If WIP is fresh (<5 min old):
#   "Agent 'claude-desktop' is currently working on F-0005"
#   "Wait for them to finish or coordinate in AGENTS_ACTIVE.md"

# If WIP is stale (>60 min old):
#   "Stale WIP detected. Previous agent may have crashed."
#   "Review git diff and decide: Continue | Rollback"
```

---

## Recovery Scenarios

### Scenario 1: Token Limit Reached Mid-Edit

**What happens:**
1. Agent editing `src/auth/login.ts`
2. Token limit reached ‚Üí Tool stops abruptly
3. WIP.md exists with last checkpoint: "Implementing JWT validation"
4. Changes uncommitted in git

**Recovery (next session):**
```bash
bash .agentic/tools/wip.sh check
# Output: "‚ö†Ô∏è Interrupted work detected. F-0005 in progress."

git diff src/auth/login.ts
# Review changes

# Continue work
# WIP.md shows: "[ ] Add JWT validation (IN PROGRESS)"
```

### Scenario 2: Tool Crash

**What happens:**
1. Agent working on feature F-0005
2. Computer crashes or tool freezes
3. WIP.md exists, SESSION_LOG.md has last checkpoint
4. Uncommitted changes in git

**Recovery (reboot, new session):**
```bash
bash .agentic/tools/wip.sh check
# "‚ö†Ô∏è WIP detected from 2 hours ago. Agent: claude-desktop"
# "Last checkpoint: Implemented login endpoint"

git status
# Shows modified files

git diff
# Review what was changed before crash

# Options:
# 1. Continue (git looks good)
# 2. Rollback (git reset --hard) if changes incomplete/broken
```

### Scenario 3: Switching Environments Mid-Task

**What happens:**
1. Claude working on F-0005
2. Tokens running low
3. User updates WIP: `bash .agentic/tools/wip.sh checkpoint "Switching to Cursor"`
4. Opens Cursor

**Recovery (Cursor session start):**
```bash
bash .agentic/tools/wip.sh check
# "‚úì WIP handoff from claude-desktop (3 minutes ago)"
# "Feature F-0005: User Authentication"
# "Last checkpoint: Switching to Cursor"

# Cursor continues seamlessly
```

### Scenario 4: Context Compaction (Claude)

**What happens:**
1. Claude PreCompact hook triggers
2. Hook updates WIP: `wip.sh checkpoint "Context compaction triggered"`
3. Context resets

**Recovery (after compaction):**
```bash
# Claude SessionStart reads WIP.md
# "‚úì Context was compacted 5 minutes ago"
# "Feature F-0005 in progress"
# Loads from WIP.md + SESSION_LOG.md
```

---

## Git Integration

### Git Diff at Recovery

When interrupted work detected:
```bash
# Show what changed since WIP started
git diff

# Show files changed
git status --short

# If needed, rollback
git reset --hard  # Nuclear option
git checkout -- <file>  # Rollback specific file
```

### Commit Safeguards

**Never commit while WIP.md exists:**

Check in `before_commit.md`:
```bash
if [[ -f "WIP.md" ]]; then
  echo "‚ö†Ô∏è  WIP.md still exists!"
  echo "   Complete work first: bash .agentic/tools/wip.sh complete"
  exit 1
fi
```

---

## WIP.md State Machine

```
[No WIP.md] ‚Üí bash wip.sh start ‚Üí [WIP.md: IN_PROGRESS]
                                         ‚Üì
                                   (work + checkpoints)
                                         ‚Üì
[WIP.md: IN_PROGRESS] ‚Üí bash wip.sh complete ‚Üí [No WIP.md] ‚Üí git commit
                                         ‚Üì
                              (if interrupted)
                                         ‚Üì
[WIP.md: STALE] ‚Üí bash wip.sh check ‚Üí Recovery prompt
                      ‚Üì
            Continue | Review | Rollback
```

---

## Best Practices

### 1. Update WIP Frequently

**Good** ‚úÖ:
```bash
# Every ~15 minutes or after significant step
bash .agentic/tools/wip.sh checkpoint "Login endpoint done"
bash .agentic/tools/wip.sh checkpoint "JWT validation added"
bash .agentic/tools/wip.sh checkpoint "Unit tests passing"
```

**Bad** ‚ùå:
```bash
# Only at start, then nothing
bash .agentic/tools/wip.sh start F-0005 "Auth"
# (30 minutes of work, no checkpoints)
# (crash - no idea what was done)
```

### 2. Always Complete WIP

**Good** ‚úÖ:
```bash
# Work done
bash .agentic/tools/wip.sh complete
git add -A && git commit -m "feat: F-0005"
```

**Bad** ‚ùå:
```bash
# Work done, but forgot to complete
git add -A && git commit -m "feat: F-0005"
# WIP.md still exists! (confusing for next session)
```

### 3. Review Before Continuing Interrupted Work

**Always check git diff before continuing:**
```bash
bash .agentic/tools/wip.sh check
# "Interrupted work detected"

git diff  # REVIEW FIRST!
# If looks good: Continue
# If broken/incomplete: Consider rollback
```

### 4. Clean WIP on Rollback

**If you rollback changes:**
```bash
git reset --hard
bash .agentic/tools/wip.sh complete  # Remove WIP lock
```

---

## Summary

**WIP tracking prevents work loss by:**
1. ‚úÖ Tracking active work (lock file)
2. ‚úÖ Detecting interruptions (session start check)
3. ‚úÖ Showing what changed (git diff integration)
4. ‚úÖ Offering recovery options (continue/review/rollback)
5. ‚úÖ Auto-updating at checkpoints (PreCompact hook)

**Integration points:**
- Session start checklist (automatic check)
- Feature workflow (create ‚Üí checkpoint ‚Üí complete)
- Claude hooks (auto-checkpoint before compaction)
- Environment switching (handoff tracking)
- Multi-agent coordination (prevent conflicts)

**Token cost:** Minimal (~50 tokens to create/update WIP.md)

**Benefit:** Never lose significant work again! üéâ

