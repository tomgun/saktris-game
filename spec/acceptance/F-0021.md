---
feature: F-0021
status: shipped
validation: []  # TODO: Add validation commands
---

# F-0021: Online Multiplayer (Phase A - P2P)

## Summary
Enable two players to play Saktris against each other online using browser-to-browser WebRTC connections, with a minimal signaling server for initial connection setup.

## Acceptance Criteria

### AC-1: Create Game
- [x] User can click "Play Online" from main menu
- [x] User can click "Create Game" to become host
- [x] System displays a 6-character room code (e.g., "AB3XY7")
- [x] Room code uses unambiguous characters (no 0/O/1/I)
- [x] Host can select which color to play (White, Black, or Random)
- [x] Host sees "Waiting for opponent..." status

### AC-2: Join Game
- [x] User can click "Join Game" from online menu
- [x] User can enter a 6-character room code
- [x] System validates code format before attempting to join
- [x] User sees "Connecting..." while WebRTC handshake occurs
- [x] User sees clear error message if room not found or connection fails

### AC-3: Connection Establishment
- [x] Host and guest connect via WebRTC DataChannel after signaling
- [x] Connection completes within 10 seconds under normal conditions
- [x] Both players see "Connected" status when P2P is established
- [x] Signaling server is only used for initial handshake

### AC-4: Game Synchronization
- [x] Host sends game settings (seed, game mode, etc.) to guest
- [x] Both clients use same RNG seed for identical piece sequences
- [x] Moves are transmitted and applied on remote client
- [x] Piece placements are transmitted and applied on remote client
- [x] Promotions are transmitted and applied on remote client

### AC-5: Turn Validation
- [x] Local player's input is enabled only on their turn
- [x] Remote player's turn disables local input (like AI mode)
- [ ] Invalid moves from remote are rejected (security)
- [x] Move sequence numbers prevent replay/duplicate issues

### AC-6: State Verification
- [ ] State hash is exchanged after each turn
- [ ] On hash mismatch, host sends full state for resync
- [ ] Game continues normally after resync

### AC-7: Game End Conditions
- [x] Checkmate detected correctly in network play
- [x] Stalemate detected correctly in network play
- [x] Draw conditions (50-move, repetition) work in network play
- [x] Player can resign (sends resign message)
- [x] Game ends cleanly on resignation

### AC-8: Disconnect Handling
- [x] Connection loss is detected within 5 seconds
- [x] Disconnected player sees "Connection lost" message
- [x] Remaining player sees "Opponent disconnected"
- [x] Players can return to main menu after disconnect

### AC-9: Lobby Features
- [ ] Host can set time control before starting
- [ ] Host can enable/disable time control
- [x] Both players see ready status in lobby
- [x] Game starts when both players are ready (action mode ready overlay)

### AC-10: UI Feedback
- [ ] Connection status indicator visible during game
- [x] Ping/latency indicator (optional, nice-to-have)
- [x] Clear indication of whose turn it is
- [x] "Opponent's turn" message when waiting

## Out of Scope (Phase B)
- Matchmaking queue
- User accounts and ratings
- Game history storage
- Spectator mode
- Reconnection to in-progress games

## Technical Notes
- Uses Godot's WebRTCPeerConnection for P2P
- Signaling via WebSocket server on Render (saktris-signaling.onrender.com)
- All game logic validated independently on both clients
- RNG synchronization via shared seed at game start
- Network retry with auto-reconnect on cold start
