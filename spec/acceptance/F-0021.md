---
feature: F-0021
status: shipped
validation: []  # TODO: Add validation commands
---

# F-0021: Online Multiplayer (Phase A - P2P)

## Summary
Enable two players to play Saktris against each other online using browser-to-browser WebRTC connections, with a minimal signaling server for initial connection setup.

## Acceptance Criteria

### AC-1: Create Game
- [ ] User can click "Play Online" from main menu
- [ ] User can click "Create Game" to become host
- [ ] System displays a 6-character room code (e.g., "AB3XY7")
- [ ] Room code uses unambiguous characters (no 0/O/1/I)
- [ ] Host can select which color to play (White or Black)
- [ ] Host sees "Waiting for opponent..." status

### AC-2: Join Game
- [ ] User can click "Join Game" from online menu
- [ ] User can enter a 6-character room code
- [ ] System validates code format before attempting to join
- [ ] User sees "Connecting..." while WebRTC handshake occurs
- [ ] User sees clear error message if room not found or connection fails

### AC-3: Connection Establishment
- [ ] Host and guest connect via WebRTC DataChannel after signaling
- [ ] Connection completes within 10 seconds under normal conditions
- [ ] Both players see "Connected" status when P2P is established
- [ ] Signaling server is only used for initial handshake

### AC-4: Game Synchronization
- [ ] Host sends game settings (seed, time control, etc.) to guest
- [ ] Both clients use same RNG seed for identical piece sequences
- [ ] Moves are transmitted and applied on remote client
- [ ] Piece placements are transmitted and applied on remote client
- [ ] Promotions are transmitted and applied on remote client

### AC-5: Turn Validation
- [ ] Local player's input is enabled only on their turn
- [ ] Remote player's turn disables local input (like AI mode)
- [ ] Invalid moves from remote are rejected (security)
- [ ] Move sequence numbers prevent replay/duplicate issues

### AC-6: State Verification
- [ ] State hash is exchanged after each turn
- [ ] On hash mismatch, host sends full state for resync
- [ ] Game continues normally after resync

### AC-7: Game End Conditions
- [ ] Checkmate detected correctly in network play
- [ ] Stalemate detected correctly in network play
- [ ] Draw conditions (50-move, repetition) work in network play
- [ ] Player can resign (sends resign message)
- [ ] Game ends cleanly on resignation

### AC-8: Disconnect Handling
- [ ] Connection loss is detected within 5 seconds
- [ ] Disconnected player sees "Connection lost" message
- [ ] Remaining player sees "Opponent disconnected"
- [ ] Players can return to main menu after disconnect

### AC-9: Lobby Features
- [ ] Host can set time control before starting
- [ ] Host can enable/disable time control
- [ ] Both players see ready status in lobby
- [ ] Game starts when both players are ready

### AC-10: UI Feedback
- [ ] Connection status indicator visible during game
- [ ] Ping/latency indicator (optional, nice-to-have)
- [ ] Clear indication of whose turn it is
- [ ] "Opponent's turn" message when waiting

## Out of Scope (Phase B)
- Matchmaking queue
- User accounts and ratings
- Game history storage
- Spectator mode
- Reconnection to in-progress games

## Technical Notes
- Use Godot's WebRTCPeerConnection for P2P
- Signaling via minimal WebSocket server (Cloudflare Workers or similar)
- All game logic validated independently on both clients
- RNG synchronization via shared seed at game start
